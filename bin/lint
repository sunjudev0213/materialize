#!/usr/bin/env bash

# Copyright 2019 Materialize, Inc. All rights reserved.
#
# This file is part of Materialize. Materialize may not be used or
# distributed without the express permission of Materialize, Inc.
#
# lint â€” complains about misformatted files.

set -euo pipefail

cd "$(dirname "$0")/.."

failed=false

try() {
    if ! "$@"; then
        failed=true
    fi
}

files=$(
    git ls-files \
        | sed 's,^.\/,,' \
        | grep -vE \
            -e '.gitignore' \
            -e '.gitmodules' \
            -e '(^|/)Cargo\.lock$' \
            -e '(^|/)Cargo\.toml$' \
            -e '^LICENSE$' \
            -e '^rust-toolchain$' \
            -e '^rustfmt.toml$' \
            -e '\.md$' \
            -e '\.json$' \
            -e '^sqllogictest$'
)

run() {
    xargs "$@" <<< "$files"
}

try run -n1 awk -f misc/lint/copyright.awk
try run -n1 misc/lint/trailing-newline.sh

if $failed; then
    exit 1
fi
