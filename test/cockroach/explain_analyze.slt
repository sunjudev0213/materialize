# Copyright 2015 - 2019 The Cockroach Authors. All rights reserved.
# Copyright 2019 Materialize, Inc. All rights reserved.
#
# This file is part of Materialize. Materialize may not be used or
# distributed without the express permission of Materialize, Inc.
#
# This file is derived from the logic test suite in CockroachDB. The
# original file was retrieved on June 10, 2019 from:
#
#     https://github.com/cockroachdb/cockroach/blob/d2f7fbf5dd1fc1a099bbad790a2e1f7c60a66cc3/pkg/sql/logictest/testdata/logic_test/explain_analyze
#
# The original source code is subject to the terms of the Apache
# 2.0 license, a copy of which can be found in the LICENSE file at the
# root of this repository.

# Regression tests for weird explain analyze cases.

statement ok
EXPLAIN ANALYZE (DISTSQL) CREATE TABLE a (a INT PRIMARY KEY)

statement ok
EXPLAIN ANALYZE (DISTSQL) CREATE INDEX ON a(a)

statement ok
EXPLAIN ANALYZE (DISTSQL) INSERT INTO a VALUES (1)

# Make sure failures are okay.
statement error duplicate
EXPLAIN ANALYZE (DISTSQL) INSERT INTO a VALUES (1)

statement error value type string doesn't match type int of column "a"
EXPLAIN ANALYZE (DISTSQL) INSERT INTO a VALUES ('a'::string)

statement ok
EXPLAIN ANALYZE (DISTSQL) INSERT INTO a SELECT a+1 FROM a

statement ok
EXPLAIN ANALYZE (DISTSQL) UPDATE a SET a = a*3

statement ok
EXPLAIN ANALYZE (DISTSQL) UPDATE a SET a = a*3 RETURNING a

statement ok
EXPLAIN ANALYZE (DISTSQL) UPSERT INTO a VALUES(10)

statement error EXPLAIN ANALYZE does not support RETURNING NOTHING statements
EXPLAIN ANALYZE (DISTSQL) UPSERT INTO a VALUES(11) RETURNING NOTHING

statement ok
EXPLAIN ANALYZE (DISTSQL) SELECT (SELECT 1);

statement ok
EXPLAIN ANALYZE (DISTSQL) DELETE FROM a

statement ok
EXPLAIN ANALYZE (DISTSQL) DROP TABLE a

# Tests with EXPLAIN ANALYZE and subqueries.

statement ok
CREATE TABLE a (a INT PRIMARY KEY)

statement ok
INSERT INTO a VALUES(1)

statement ok
PREPARE x AS EXPLAIN ANALYZE(DISTSQL) SELECT 1 WHERE EXISTS (SELECT * FROM a WHERE a = $1) AND EXISTS (SELECT 1 WHERE EXISTS (SELECT * FROM a WHERE a = $2))

statement ok
EXECUTE x(1, 2)

statement ok
PREPARE y AS EXPLAIN ANALYZE(DISTSQL) SELECT 1 WHERE EXISTS (SELECT * FROM a WHERE a = $1) AND EXISTS (SELECT 1 WHERE EXISTS (SELECT * FROM a WHERE a = $1))

statement ok
EXECUTE x(1, 1)

# Regression test for #34927.
statement ok
EXPLAIN ANALYZE (DISTSQL) DELETE FROM a WHERE true
