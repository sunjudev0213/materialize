# Copyright 2015 - 2019 The Cockroach Authors. All rights reserved.
# Copyright 2019 Materialize, Inc. All rights reserved.
#
# This file is part of Materialize. Materialize may not be used or
# distributed without the express permission of Materialize, Inc.
#
# This file is derived from the logic test suite in CockroachDB. The
# original file was retrieved on June 10, 2019 from:
#
#     https://github.com/cockroachdb/cockroach/blob/d2f7fbf5dd1fc1a099bbad790a2e1f7c60a66cc3/pkg/sql/logictest/testdata/logic_test/rename_index
#
# The original source code is subject to the terms of the Apache
# 2.0 license, a copy of which can be found in the LICENSE file at the
# root of this repository.

statement ok
CREATE TABLE users (
  id    INT PRIMARY KEY,
  name  VARCHAR NOT NULL,
  title VARCHAR,
  INDEX foo (name),
  UNIQUE INDEX bar (id, name)
)

statement ok
INSERT INTO users VALUES (1, 'tom', 'cat'),(2, 'jerry', 'rat')

query TTBITTBB colnames
SHOW INDEXES FROM users
----
table_name  index_name  non_unique  seq_in_index  column_name  direction  storing  implicit
users       primary     false       1             id           ASC        false    false
users       foo         true        1             name         ASC        false    false
users       foo         true        2             id           ASC        false    true
users       bar         false       1             id           ASC        false    false
users       bar         false       2             name         ASC        false    false

statement error index name "bar" already exists
ALTER INDEX users@foo RENAME TO bar

statement error empty index name
ALTER INDEX users@foo RENAME TO ""

statement error index "ffo" does not exist
ALTER INDEX users@ffo RENAME TO ufo

statement ok
ALTER INDEX IF EXISTS users@ffo RENAME TO ufo

statement ok
ALTER INDEX users@foo RENAME TO ufoo

statement ok
ALTER INDEX ufoo RENAME TO ufo

query TTBITTBB colnames
SHOW INDEXES FROM users
----
table_name  index_name  non_unique  seq_in_index  column_name  direction  storing  implicit
users       primary     false       1             id           ASC        false    false
users       ufo         true        1             name         ASC        false    false
users       ufo         true        2             id           ASC        false    true
users       bar         false       1             id           ASC        false    false
users       bar         false       2             name         ASC        false    false

user testuser

statement error user testuser does not have CREATE privilege on relation users
ALTER INDEX users@bar RENAME TO rar

user root

statement ok
GRANT CREATE ON TABLE users TO testuser

user testuser

statement ok
ALTER INDEX users@bar RENAME TO rar

query TTBITTBB colnames
SHOW INDEXES FROM users
----
table_name  index_name  non_unique  seq_in_index  column_name  direction  storing  implicit
users       primary     false       1             id           ASC        false    false
users       ufo         true        1             name         ASC        false    false
users       ufo         true        2             id           ASC        false    true
users       rar         false       1             id           ASC        false    false
users       rar         false       2             name         ASC        false    false

user root

query ITT rowsort
SELECT * FROM users
----
1 tom   cat
2 jerry rat

statement ok
CREATE VIEW v AS SELECT name FROM users@{FORCE_INDEX=ufo}

statement error cannot rename index "ufo" because view "v" depends on it
ALTER INDEX users@ufo RENAME TO foo

statement ok
ALTER INDEX users@rar RENAME TO bar

# Regression test for #24774
statement ok
ALTER INDEX users@"primary" RENAME TO pk

query ITT rowsort
SELECT * FROM users@pk
----
1 tom   cat
2 jerry rat

query TTT
EXPLAIN ALTER INDEX users@bar RENAME TO woo
----
rename index  ·  ·

# Verify that EXPLAIN did not actually rename the index (#30543)
query T rowsort
SELECT DISTINCT index_name FROM [SHOW INDEXES FROM users]
----
pk
ufo
bar
