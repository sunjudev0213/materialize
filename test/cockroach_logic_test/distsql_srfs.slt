# Copyright 2015 - 2019 The Cockroach Authors. All rights reserved.
# Copyright 2019 Materialize, Inc. All rights reserved.
#
# This file is part of Materialize. Materialize may not be used or
# distributed without the express permission of Materialize, Inc.
#
# This file is derived from the logic test suite in CockroachDB. The
# original file was retrieved on June 10, 2019 from:
#
#     https://github.com/cockroachdb/cockroach/blob/d2f7fbf5dd1fc1a099bbad790a2e1f7c60a66cc3/pkg/sql/logictest/testdata/logic_test/distsql_srfs
#
# The original source code is subject to the terms of the Apache
# 2.0 license, a copy of which can be found in the LICENSE file at the
# root of this repository.

statement ok
CREATE TABLE data (a INT PRIMARY KEY)

statement ok
INSERT INTO data SELECT generate_series(0, 9)

# Correlated SRF
query II
SELECT a, generate_series(a, a + 1) FROM data ORDER BY 1, 2
----
0  0
0  1
1  1
1  2
2  2
2  3
3  3
3  4
4  4
4  5
5  5
5  6
6  6
6  7
7  7
7  8
8  8
8  9
9  9
9  10

# Filter on ProjectSet node
query II rowsort
SELECT a, b FROM (SELECT a, generate_series(1, 3) AS b FROM data) WHERE a < 4 AND b = 3
----
0  3
1  3
2  3
3  3

# Multiple SRFs with different lengths
query III
SELECT a, generate_series(1, 2), generate_series(1, 4) FROM data WHERE a < 2 ORDER BY 1, 2, 3
----
0  NULL  3
0  NULL  4
0  1     1
0  2     2
1  NULL  3
1  NULL  4
1  1     1
1  2     2

statement ok
CREATE TABLE groups(
  id SERIAL,
  data jsonb,
  primary key (id)
)

query TT
SELECT g.data->>'name' AS group_name, jsonb_array_elements(g.data->'members') FROM groups g;
----
