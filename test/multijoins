# Copyright 2019 Materialize, Inc. All rights reserved.
#
# This file is part of Materialize. Materialize may not be used or
# distributed without the express permission of Materialize, Inc.

$ kafka-ingest format=avro topic=names schema={
    "type": "record",
    "name": "na",
    "fields": [
        {"name": "num", "type": "long"},
        {"name": "name", "type": "string"}
    ]
  }
{"num": 1, "name": "one"}
{"num": 2, "name": "two"}
{"num": 3, "name": "three"}

> CREATE DATA SOURCE names FROM 'kafka://localhost/names' USING SCHEMA '{
    "type": "record",
    "name": "na",
    "fields": [
        {"name": "num", "type": "long"},
        {"name": "name", "type": "string"}
    ]
  }'

$ kafka-ingest format=avro topic=mods schema={
    "type": "record",
    "name": "na",
    "fields": [
        {"name": "num", "type": "long"},
        {"name": "name", "type": "string"}
    ]
  }
{"num": 0, "name": "even"}
{"num": 1, "name": "odd"}
{"num": 2, "name": "even"}

> CREATE DATA SOURCE mods FROM 'kafka://localhost/mods' USING SCHEMA '{
    "type": "record",
    "name": "na",
    "fields": [
        {"name": "num", "type": "long"},
        {"name": "mod", "type": "string"}
    ]
  }'

$ kafka-ingest format=avro topic=plurals schema={
    "type": "record",
    "name": "na",
    "fields": [
        {"name": "num", "type": "string"},
        {"name": "noun", "type": "string"}
    ]
  }
{"num": "one", "noun": "sheep"}
{"num": "two", "noun": "sheep"}
{"num": "one", "noun": "mouse"}
{"num": "two", "noun": "meeses"}

> CREATE DATA SOURCE plurals FROM 'kafka://localhost/plurals' USING SCHEMA '{
    "type": "record",
    "name": "na",
    "fields": [
        {"name": "num", "type": "string"},
        {"name": "noun", "type": "string"}
    ]
  }'

> CREATE MATERIALIZED VIEW test1 AS
  SELECT * FROM names, mods, plurals WHERE names.num = mods.num AND names.name = plurals.num;

> PEEK test1;
num name num mod num plurals
----------------------------
1 one 1 odd one sheep
1 one 1 odd one mouse
2 two 2 even two sheep
2 two 2 even two meeses

> CREATE MATERIALIZED VIEW test2 AS
  SELECT * FROM names, mods, plurals WHERE names.num = mods.num AND names.name = plurals.num AND plurals.num = 'one';

> PEEK test2;
num name num mod num plurals
----------------------------
1 one 1 odd one sheep
1 one 1 odd one mouse

> CREATE MATERIALIZED VIEW test3 AS
  SELECT * FROM names RIGHT JOIN mods ON names.num = mods.num LEFT JOIN plurals ON names.name = plurals.num;

> PEEK test3;
num name num mod num plurals
----------------------------
<null> <null> 0 even <null> <null>
1 one 1 odd one sheep
1 one 1 odd one mouse
2 two 2 even two sheep
2 two 2 even two meeses

> CREATE MATERIALIZED VIEW test4 AS
  SELECT * FROM names, mods, plurals as foo WHERE names.num = mods.num AND names.name = foo.num AND foo.num = 'one';

> PEEK test4;
num name num mod num plurals
----------------------------
1 one 1 odd one sheep
1 one 1 odd one mouse